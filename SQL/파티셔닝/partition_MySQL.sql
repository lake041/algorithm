DROP TABLE transactions;

CREATE TABLE transactions (
    id BIGINT AUTO_INCREMENT,
    transaction_time TIMESTAMP,
    account_id BIGINT NOT NULL,
    transaction_location BIGINT NOT NULL,
    transaction_amount BIGINT NOT NULL,
    PRIMARY KEY (id, transaction_time)
)
PARTITION BY RANGE (UNIX_TIMESTAMP(transaction_time)) (
    PARTITION p20240101 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-02 00:00:00')),
    PARTITION p20240102 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-03 00:00:00')),
    PARTITION p20240103 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-04 00:00:00')),
    PARTITION p20240104 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-05 00:00:00')),
    PARTITION p20240105 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-06 00:00:00')),
    PARTITION p20240106 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-07 00:00:00')),
    PARTITION p20240107 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-08 00:00:00')),
    PARTITION p20240108 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-09 00:00:00')),
    PARTITION p20240109 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-10 00:00:00')),
    PARTITION p20240110 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-11 00:00:00')),
    PARTITION p20240111 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-12 00:00:00')),
    PARTITION p20240112 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-13 00:00:00')),
    PARTITION p20240113 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-14 00:00:00')),
    PARTITION p20240114 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-15 00:00:00')),
    PARTITION p20240115 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-16 00:00:00')),
    PARTITION p20240116 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-17 00:00:00')),
    PARTITION p20240117 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-18 00:00:00')),
    PARTITION p20240118 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-19 00:00:00')),
    PARTITION p20240119 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-20 00:00:00')),
    PARTITION p20240120 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-21 00:00:00')),
    PARTITION p20240121 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-22 00:00:00')),
    PARTITION p20240122 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-23 00:00:00')),
    PARTITION p20240123 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-24 00:00:00')),
    PARTITION p20240124 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-25 00:00:00')),
    PARTITION p20240125 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-26 00:00:00')),
    PARTITION p20240126 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-27 00:00:00')),
    PARTITION p20240127 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-28 00:00:00')),
    PARTITION p20240128 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-29 00:00:00')),
    PARTITION p20240129 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-30 00:00:00')),
    PARTITION p20240130 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-31 00:00:00')),
    PARTITION p20240131 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-01 00:00:00')),
    PARTITION p20240201 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-02 00:00:00')),
    PARTITION p20240202 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-03 00:00:00')),
    PARTITION p20240203 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-04 00:00:00')),
    PARTITION p20240204 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-05 00:00:00')),
    PARTITION p20240205 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-06 00:00:00')),
    PARTITION p20240206 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-07 00:00:00')),
    PARTITION p20240207 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-08 00:00:00')),
    PARTITION p20240208 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-09 00:00:00')),
    PARTITION p20240209 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-10 00:00:00')),
    PARTITION p20240210 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-11 00:00:00')),
    PARTITION p20240211 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-12 00:00:00')),
    PARTITION p20240212 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-13 00:00:00')),
    PARTITION p20240213 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-14 00:00:00')),
    PARTITION p20240214 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-15 00:00:00')),
    PARTITION p20240215 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-16 00:00:00')),
    PARTITION p20240216 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-17 00:00:00')),
    PARTITION p20240217 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-18 00:00:00')),
    PARTITION p20240218 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-19 00:00:00')),
    PARTITION p20240219 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-20 00:00:00')),
    PARTITION p20240220 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-21 00:00:00')),
    PARTITION p20240221 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-22 00:00:00')),
    PARTITION p20240222 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-23 00:00:00')),
    PARTITION p20240223 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-24 00:00:00')),
    PARTITION p20240224 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-25 00:00:00')),
    PARTITION p20240225 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-26 00:00:00')),
    PARTITION p20240226 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-27 00:00:00')),
    PARTITION p20240227 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-28 00:00:00')),
    PARTITION p20240228 VALUES LESS THAN (UNIX_TIMESTAMP('2024-02-29 00:00:00')),
    PARTITION p20240229 VALUES LESS THAN (UNIX_TIMESTAMP('2024-03-01 00:00:00')),
    PARTITION pmax VALUES LESS THAN MAXVALUE
);

CREATE INDEX idx_transactions_account_id ON transactions (account_id);

SET profiling = 1;

EXPLAIN
SELECT *
FROM transactions
WHERE
    account_id = 2000000 AND
    '2024-01-20 00:00:00' <= transaction_time AND
    transaction_time < '2024-01-27 00:00:00';
    
SELECT * FROM performance_schema.events_statements_history_long;

-- 성능 스키마 활성화
UPDATE performance_schema.setup_instruments SET ENABLED = 'YES', TIMED = 'YES'
WHERE NAME LIKE 'statement/%';
-- 쿼리 실행 후 성능 데이터 확인
SELECT * FROM performance_schema.events_statements_history_long;

SHOW VARIABLES LIKE 'innodb_buffer_pool_size';

SELECT * FROM transactions_1 WHERE account_id = 1000000 AND '2024-01-22 00:00:00' <= transaction_time AND transaction_time < '2024-02-01 00:00:00';
SHOW PROFILES;


--------------------

CREATE TABLE transactions_2 (
    id BIGINT AUTO_INCREMENT,
    transaction_time TIMESTAMP NOT NULL,
    account_id BIGINT NOT NULL,
    transaction_location BIGINT NOT NULL,
    transaction_amount BIGINT NOT NULL,
    PRIMARY KEY (id)
);

CREATE INDEX idx_transactions_account_time ON transactions_2 (account_id, transaction_time);

----------------------




CREATE TABLE transactions_3 (
    id BIGINT UNIQUE AUTO_INCREMENT,
    transaction_time TIMESTAMP NOT NULL,
    account_id BIGINT NOT NULL,
    transaction_location BIGINT NOT NULL,
    transaction_amount BIGINT NOT NULL,
    PRIMARY KEY (transaction_time)
)
PARTITION BY RANGE (UNIX_TIMESTAMP(transaction_time)) (
    PARTITION pp20240101 VALUES LESS THAN (UNIX_TIMESTAMP('2024-01-02 00:00:00')),
    PARTITION ppmax VALUES LESS THAN MAXVALUE
);

-------

EXPLAIN
SELECT *
FROM transactions_1
WHERE
    account_id = 2000000 AND
    '2024-01-20 00:00:00' <= transaction_time AND
    transaction_time < '2024-01-27 00:00:00';

SET profiling = 1;
SELECT * FROM transactions_1 WHERE account_id = 2000000 AND '2024-01-21 00:00:00' <= transaction_time AND transaction_time < '2024-01-28 00:00:00';
SELECT * FROM transactions_2 WHERE account_id = 2000000 AND '2024-01-21 00:00:00' <= transaction_time AND transaction_time < '2024-01-28 00:00:00';
SELECT * FROM transactions_1 WHERE account_id = 1000000 AND '2024-01-14 00:00:00' <= transaction_time AND transaction_time < '2024-01-15 00:00:00';
SELECT * FROM transactions_2 WHERE account_id = 1000000 AND '2024-01-14 00:00:00' <= transaction_time AND transaction_time < '2024-01-15 00:00:00';
SHOW PROFILES;
